generator client {
  provider   = "prisma-client"
  output     = "../src/generated/prisma/client"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                    Int            @id @default(autoincrement())
  name                  String?
  email                 String         @unique
  username              String?        @unique
  bio                   String?
  location              String?
  website               String?
  password              String
  resetCode             String?
  resetCodeExpiry       DateTime?
  createdAt             DateTime       @default(now())
  stripeCustomerId      String?
  nextBillingDate       DateTime?
  currentPlan           String?
  updatedAt             DateTime       @default(now()) @updatedAt
  subscriptionTier      String?        @default("free")
  subscriptionExpiry    DateTime?
  subscriptionProductId String?
  subscriptionStatus    String?        @default("active")
  subscriptionUpdatedAt DateTime?
  karma                 Int            @default(0)
  isVerified            Boolean        @default(false)
  verifiedBadge         String?
  profileComplete       Boolean        @default(false)
  posts                 Post[]
  comments              Comment[]
  commentLikes          CommentLike[]  @relation("UserCommentLikes")
  likes                 Like[]
  reactions             Reaction[]
  following             Follow[]       @relation("Following")
  followers             Follow[]       @relation("Followers")
  notifications         Notification[] @relation("NotificationReceiver")
  notificationsFrom     Notification[] @relation("NotificationFromUser")
  profileImage          String?
  bannerImage           String?
  reportsMade           Report[]       @relation("ReportsMade")
  reportsReceived       Report[]       @relation("ReportsReceived")
  mutersOf              Mute[]         @relation("MutedRelation")
  mutedUsers            Mute[]         @relation("MuterRelation")
  blockedBy             Block[]        @relation("BlockedRelation")
  blockedUsers          Block[]        @relation("BlockerRelation")
  sentiments            Sentiment[]
  mentionedIn           Mention[]      @relation("MentionedUser")
  watchlist             WatchlistItem[]
  deviceTokens          DeviceToken[]
  priceAlerts           PriceAlert[]
}

model Forum {
  id          Int      @id @default(autoincrement())
  title       String
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  posts       Post[]
}

model Post {
  id            Int            @id @default(autoincrement())
  title         String
  content       String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  forumId       Int
  userId        Int
  forum         Forum          @relation(fields: [forumId], references: [id])
  user          User           @relation(fields: [userId], references: [id])
  comments      Comment[]
  likes         Like[]
  commentLikes  Int            @default(0)
  mediaUrl      String?
  reactions     Reaction[]
  notifications Notification[]
  reports       Report[]
  sentiments    Sentiment[]
  tickerMentions TickerMention[]
  mentions      Mention[]
}

model Comment {
  id         Int      @id @default(autoincrement())
  content    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  postId     Int
  userId     Int
  parentId   Int?
  mediaUrl   String?
  mediaType  String?
  likesCount Int      @default(0)
  isDeleted  Boolean  @default(false)
  isFlagged  Boolean  @default(false)

  post              Post          @relation(fields: [postId], references: [id])
  user              User          @relation(fields: [userId], references: [id])
  likes             CommentLike[] @relation("CommentLikes")
  parent            Comment?      @relation("CommentReplies", fields: [parentId], references: [id])
  replies           Comment[]     @relation("CommentReplies")
  likesViaLikeModel Like[]
  reactions         Reaction[]
  reports           Report[]

  @@index([postId])
  @@index([parentId])
}

model Like {
  id        Int  @id @default(autoincrement())
  userId    Int
  postId    Int?
  commentId Int?

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post    Post?    @relation(fields: [postId], references: [id])
  comment Comment? @relation(fields: [commentId], references: [id])

  createdAt DateTime @default(now())
}

model CommentLike {
  id        Int      @id @default(autoincrement())
  userId    Int
  commentId Int
  createdAt DateTime @default(now())

  user    User    @relation("UserCommentLikes", fields: [userId], references: [id])
  comment Comment @relation("CommentLikes", fields: [commentId], references: [id])

  @@unique([userId, commentId])
}

model Reaction {
  id        Int      @id @default(autoincrement())
  userId    Int
  postId    Int?
  commentId Int?
  emoji     String
  createdAt DateTime @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post    Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, postId, emoji])
  @@unique([userId, commentId, emoji])
}

model Follow {
  id          Int      @id @default(autoincrement())
  followerId  Int
  followingId Int
  follower    User     @relation("Following", fields: [followerId], references: [id])
  following   User     @relation("Followers", fields: [followingId], references: [id])
  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
}

model Notification {
  id         Int      @id @default(autoincrement())
  userId     Int
  actorId    Int?
  type       String
  postId     Int?
  message    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  fromUserId Int?

  fromUser User? @relation("NotificationFromUser", fields: [fromUserId], references: [id])
  user     User  @relation("NotificationReceiver", fields: [userId], references: [id])
  post     Post? @relation(fields: [postId], references: [id])
}

model Report {
  id             Int       @id @default(autoincrement())
  reporterId     Int
  reportedUserId Int?
  postId         Int?
  commentId      Int?
  reason         String
  description    String?
  status         String    @default("pending")
  priority       String?
  resolution     String?
  resolvedAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  reporter     User     @relation("ReportsMade", fields: [reporterId], references: [id])
  reportedUser User?    @relation("ReportsReceived", fields: [reportedUserId], references: [id])
  post         Post?    @relation(fields: [postId], references: [id])
  comment      Comment? @relation(fields: [commentId], references: [id])
}

model Mute {
  id       Int      @id @default(autoincrement())
  oderId   Int
  mutedId  Int
  createdAt DateTime @default(now())
  
  oder     User     @relation("MuterRelation", fields: [oderId], references: [id])
  muted    User     @relation("MutedRelation", fields: [mutedId], references: [id])
  
  @@unique([oderId, mutedId], name: "oderId_mutedId")
}

model Block {
  id         Int      @id @default(autoincrement())
  blockerId  Int
  blockedId  Int
  createdAt  DateTime @default(now())

  blocker    User     @relation("BlockerRelation", fields: [blockerId], references: [id])
  blocked    User     @relation("BlockedRelation", fields: [blockedId], references: [id])

  @@unique([blockerId, blockedId], name: "blockerId_blockedId")
}

// Sentiment voting (Bullish/Bearish like StockTwits)
model Sentiment {
  id        Int      @id @default(autoincrement())
  userId    Int
  postId    Int
  type      String   // "bullish" or "bearish"
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
}

// Ticker mentions ($AAPL, $TSLA, etc.)
model TickerMention {
  id        Int      @id @default(autoincrement())
  ticker    String   // e.g., "AAPL", "TSLA"
  postId    Int
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([ticker])
  @@index([postId])
}

// User mentions (@username)
model Mention {
  id              Int      @id @default(autoincrement())
  mentionedUserId Int
  postId          Int
  createdAt       DateTime @default(now())

  mentionedUser   User     @relation("MentionedUser", fields: [mentionedUserId], references: [id], onDelete: Cascade)
  post            Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([mentionedUserId])
  @@index([postId])
}

// Watchlist items (add stocks to watchlist from posts)
model WatchlistItem {
  id        Int      @id @default(autoincrement())
  userId    Int
  ticker    String
  notes     String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, ticker])
}

// Trending tickers (aggregated data)
model TrendingTicker {
  id           Int      @id @default(autoincrement())
  ticker       String   @unique
  mentionCount Int      @default(0)
  sentiment    Float?   // -1 to 1 (bearish to bullish)
  lastUpdated  DateTime @default(now())
}

// Device tokens for push notifications
model DeviceToken {
  id         Int      @id @default(autoincrement())
  userId     Int
  pushToken  String   @unique
  platform   String   // "ios" or "android"
  deviceName String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([pushToken])
}

// Price alerts for stock price notifications
model PriceAlert {
  id          Int      @id @default(autoincrement())
  userId      Int
  symbol      String   // Stock ticker symbol (e.g., "AAPL")
  targetPrice Float    // Target price to trigger alert
  direction   String   // "above" or "below"
  isActive    Boolean  @default(true)
  isTriggered Boolean  @default(false)
  triggeredAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([symbol])
  @@index([isActive, isTriggered])
}
