generator client {
  provider   = "prisma-client"
  output     = "../src/generated/prisma/client"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                    Int            @id @default(autoincrement())
  name                  String?
  email                 String         @unique
  username              String?        @unique
  bio                   String?
  location              String?
  website               String?
  password              String
  resetCode             String?
  resetCodeExpiry       DateTime?
  createdAt             DateTime       @default(now())
  stripeCustomerId      String?
  nextBillingDate       DateTime?
  currentPlan           String?
  updatedAt             DateTime       @default(now()) @updatedAt
  subscriptionTier      String?        @default("free")
  subscriptionExpiry    DateTime?
  subscriptionProductId String?
  subscriptionStatus    String?        @default("active")
  subscriptionUpdatedAt DateTime?
  karma                 Int            @default(0)
  isVerified            Boolean        @default(false)
  verifiedBadge         String?
  profileComplete       Boolean        @default(false)
  // Referral fields
  referralCode          String?        @unique
  referredBy            Int?           // ID of the user who referred this user
  referralPremiumDays   Int            @default(0) // Total premium days earned from referrals
  referralPremiumExpiry DateTime?      // When referral premium expires
  posts                 Post[]
  comments              Comment[]
  commentLikes          CommentLike[]  @relation("UserCommentLikes")
  likes                 Like[]
  reactions             Reaction[]
  following             Follow[]       @relation("Following")
  followers             Follow[]       @relation("Followers")
  notifications         Notification[] @relation("NotificationReceiver")
  notificationsFrom     Notification[] @relation("NotificationFromUser")
  profileImage          String?
  bannerImage           String?
  reportsMade           Report[]       @relation("ReportsMade")
  reportsReceived       Report[]       @relation("ReportsReceived")
  mutersOf              Mute[]         @relation("MutedRelation")
  mutedUsers            Mute[]         @relation("MuterRelation")
  blockedBy             Block[]        @relation("BlockedRelation")
  blockedUsers          Block[]        @relation("BlockerRelation")
  sentiments            Sentiment[]
  mentionedIn           Mention[]      @relation("MentionedUser")
  watchlist             WatchlistItem[]
  deviceTokens          DeviceToken[]
  conversationsAsUser1  Conversation[]   @relation("ConversationUser1")
  conversationsAsUser2  Conversation[]   @relation("ConversationUser2")
  messagesSent          Message[]        @relation("MessagesSent")
  portfolios            Portfolio[]
  priceAlerts           PriceAlert[]
  referralsMade         Referral[]       @relation("ReferrerUser")
  referralsReceived     Referral[]       @relation("ReferredUser")
  bugReports            BugReport[]
  screenerPresets       ScreenerPreset[]
}

model Forum {
  id          Int      @id @default(autoincrement())
  title       String
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  posts       Post[]
}

model Post {
  id            Int            @id @default(autoincrement())
  title         String
  content       String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  forumId       Int
  userId        Int
  forum         Forum          @relation(fields: [forumId], references: [id])
  user          User           @relation(fields: [userId], references: [id])
  comments      Comment[]
  likes         Like[]
  commentLikes  Int            @default(0)
  mediaUrl      String?
  reactions     Reaction[]
  notifications Notification[]
  reports       Report[]
  sentiments    Sentiment[]
  tickerMentions TickerMention[]
  mentions      Mention[]
  views         PostView[]
}

// Post view tracking for insights
model PostView {
  id        Int      @id @default(autoincrement())
  postId    Int
  userId    Int?     // Null for anonymous views
  viewedAt  DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
  @@index([viewedAt])
}

model Comment {
  id         Int      @id @default(autoincrement())
  content    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  postId     Int
  userId     Int
  parentId   Int?
  mediaUrl   String?
  mediaType  String?
  likesCount Int      @default(0)
  isDeleted  Boolean  @default(false)
  isFlagged  Boolean  @default(false)

  post              Post          @relation(fields: [postId], references: [id])
  user              User          @relation(fields: [userId], references: [id])
  likes             CommentLike[] @relation("CommentLikes")
  parent            Comment?      @relation("CommentReplies", fields: [parentId], references: [id])
  replies           Comment[]     @relation("CommentReplies")
  likesViaLikeModel Like[]
  reactions         Reaction[]
  reports           Report[]

  @@index([postId])
  @@index([parentId])
}

model Like {
  id        Int  @id @default(autoincrement())
  userId    Int
  postId    Int?
  commentId Int?

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post    Post?    @relation(fields: [postId], references: [id])
  comment Comment? @relation(fields: [commentId], references: [id])

  createdAt DateTime @default(now())
}

model CommentLike {
  id        Int      @id @default(autoincrement())
  userId    Int
  commentId Int
  createdAt DateTime @default(now())

  user    User    @relation("UserCommentLikes", fields: [userId], references: [id])
  comment Comment @relation("CommentLikes", fields: [commentId], references: [id])

  @@unique([userId, commentId])
}

model Reaction {
  id        Int      @id @default(autoincrement())
  userId    Int
  postId    Int?
  commentId Int?
  emoji     String
  createdAt DateTime @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post    Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, postId, emoji])
  @@unique([userId, commentId, emoji])
}

model Follow {
  id          Int      @id @default(autoincrement())
  followerId  Int
  followingId Int
  follower    User     @relation("Following", fields: [followerId], references: [id])
  following   User     @relation("Followers", fields: [followingId], references: [id])
  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
}

model Notification {
  id         Int      @id @default(autoincrement())
  userId     Int
  actorId    Int?
  type       String
  postId     Int?
  message    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  fromUserId Int?

  fromUser User? @relation("NotificationFromUser", fields: [fromUserId], references: [id])
  user     User  @relation("NotificationReceiver", fields: [userId], references: [id])
  post     Post? @relation(fields: [postId], references: [id])
}

model Report {
  id             Int       @id @default(autoincrement())
  reporterId     Int
  reportedUserId Int?
  postId         Int?
  commentId      Int?
  reason         String
  description    String?
  status         String    @default("pending")
  priority       String?
  resolution     String?
  resolvedAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  reporter     User     @relation("ReportsMade", fields: [reporterId], references: [id])
  reportedUser User?    @relation("ReportsReceived", fields: [reportedUserId], references: [id])
  post         Post?    @relation(fields: [postId], references: [id])
  comment      Comment? @relation(fields: [commentId], references: [id])
}

model Mute {
  id       Int      @id @default(autoincrement())
  oderId   Int
  mutedId  Int
  createdAt DateTime @default(now())
  
  oder     User     @relation("MuterRelation", fields: [oderId], references: [id])
  muted    User     @relation("MutedRelation", fields: [mutedId], references: [id])
  
  @@unique([oderId, mutedId], name: "oderId_mutedId")
}

model Block {
  id         Int      @id @default(autoincrement())
  blockerId  Int
  blockedId  Int
  createdAt  DateTime @default(now())

  blocker    User     @relation("BlockerRelation", fields: [blockerId], references: [id])
  blocked    User     @relation("BlockedRelation", fields: [blockedId], references: [id])

  @@unique([blockerId, blockedId], name: "blockerId_blockedId")
}

// Sentiment voting (Bullish/Bearish like StockTwits)
model Sentiment {
  id        Int      @id @default(autoincrement())
  userId    Int
  postId    Int
  type      String   // "bullish" or "bearish"
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
}

// Ticker mentions ($AAPL, $TSLA, etc.)
model TickerMention {
  id        Int      @id @default(autoincrement())
  ticker    String   // e.g., "AAPL", "TSLA"
  postId    Int
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([ticker])
  @@index([postId])
}

// User mentions (@username)
model Mention {
  id              Int      @id @default(autoincrement())
  mentionedUserId Int
  postId          Int
  createdAt       DateTime @default(now())

  mentionedUser   User     @relation("MentionedUser", fields: [mentionedUserId], references: [id], onDelete: Cascade)
  post            Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([mentionedUserId])
  @@index([postId])
}

// Watchlist items (add stocks to watchlist from posts)
model WatchlistItem {
  id        Int      @id @default(autoincrement())
  userId    Int
  ticker    String
  notes     String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, ticker])
}

// Trending tickers (aggregated data)
model TrendingTicker {
  id           Int      @id @default(autoincrement())
  ticker       String   @unique
  mentionCount Int      @default(0)
  sentiment    Float?   // -1 to 1 (bearish to bullish)
  lastUpdated  DateTime @default(now())
}

// Device tokens for push notifications
model DeviceToken {
  id         Int      @id @default(autoincrement())
  userId     Int
  pushToken  String   @unique
  platform   String   // "ios" or "android"
  deviceName String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([pushToken])
}

// Direct Messages - Conversation between two users
model Conversation {
  id            Int       @id @default(autoincrement())
  participant1  Int
  participant2  Int
  lastMessage   String?
  lastMessageAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user1         User      @relation("ConversationUser1", fields: [participant1], references: [id], onDelete: Cascade)
  user2         User      @relation("ConversationUser2", fields: [participant2], references: [id], onDelete: Cascade)
  messages      Message[]

  @@unique([participant1, participant2])
  @@index([participant1])
  @@index([participant2])
}

// Direct Messages
model Message {
  id             Int          @id @default(autoincrement())
  conversationId Int
  senderId       Int
  content        String
  imageUrl       String?
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
}

// Portfolio tracking
model Portfolio {
  id        Int                @id @default(autoincrement())
  userId    Int
  name      String             @default("My Portfolio")
  isDefault Boolean            @default(false)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  holdings  PortfolioHolding[]

  @@index([userId])
}

model PortfolioHolding {
  id          Int       @id @default(autoincrement())
  portfolioId Int
  symbol      String
  shares      Float
  avgCost     Float
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@unique([portfolioId, symbol])
  @@index([portfolioId])
  @@index([symbol])
}

// Price alerts
model PriceAlert {
  id          Int       @id @default(autoincrement())
  userId      Int
  symbol      String
  targetPrice Float
  direction   String
  isActive    Boolean   @default(true)
  isTriggered Boolean   @default(false)
  triggeredAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isActive, isTriggered])
  @@index([symbol])
  @@index([userId])
}

// Referral tracking
model Referral {
  id              Int       @id @default(autoincrement())
  referrerId      Int       // User who made the referral (owner of the code)
  referredUserId  Int       // User who was referred (used the code)
  referralCode    String    // The code that was used
  status          String    @default("pending") // pending, completed, rewarded
  rewardDays      Int       @default(0) // Days awarded for this referral
  completedAt     DateTime? // When the referral was completed
  rewardedAt      DateTime? // When the reward was applied
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  referrer        User      @relation("ReferrerUser", fields: [referrerId], references: [id], onDelete: Cascade)
  referredUser    User      @relation("ReferredUser", fields: [referredUserId], references: [id], onDelete: Cascade)

  @@unique([referrerId, referredUserId])
  @@index([referrerId])
  @@index([referredUserId])
  @@index([referralCode])
}

// Bug reports from users
model BugReport {
  id            Int       @id @default(autoincrement())
  userId        Int?      // Optional - can be submitted without login
  category      String    // app_crash, ui_issue, slow_laggy, data_error, login_issue, other
  description   String
  contactEmail  String?
  screenshotUrl String?
  deviceInfo    String?   // JSON string with device details
  appVersion    String?
  status        String    @default("pending") // pending, in_progress, resolved, closed
  priority      String?   // low, medium, high, critical
  adminNotes    String?
  resolvedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([category])
  @@index([status])
}

// Screener filter presets saved by users
model ScreenerPreset {
  id        Int      @id @default(autoincrement())
  userId    Int
  name      String
  filters   Json     // Stores the filter key-value pairs
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Sent notification tracking for deduplication (market movers, news)
model SentNotification {
  id             Int      @id @default(autoincrement())
  type           String   // "market_mover" or "market_news"
  externalId     String   // Unique key: "{symbol}_{date}_{direction}" or article URL hash
  title          String
  sentAt         DateTime @default(now())
  recipientCount Int?
  onesignalId    String?

  @@unique([type, externalId])
  @@index([type])
  @@index([sentAt])
}
